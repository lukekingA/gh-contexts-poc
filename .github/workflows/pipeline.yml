name: jobs context poc

on: [push]

env:
  SLOBS: 

jobs:
  job-1:
    runs-on: ubuntu-latest
    steps:
      - name: echo job-1
        run: echo "job-1"

  check-changes:
    runs-on: ubuntu-latest
    steps:
      - name: checkout
        uses: actions/checkout@v2
      - name: find changes
        id: find_changes
        run: |
          git diff 
          echo "::set-output name=changes::$(git diff --name-only ${{ github.event.before }} ${{ github.sha }})"


  job-2:
    needs: job-1
    uses: ./.github/workflows/run_sometimes.yml

  job-3:
    runs-on: ubuntu-latest
    needs: job-2
    steps:
      - name: echo job-3
        run: |
          echo "job-3"
          exit 1

  job-4:
    runs-on: ubuntu-latest
    needs: [job-1, job-2, job-3]
    if: failure()
    steps:
      - name: find failed job
        env:
          JOBS: ${{ toJson(needs) }}
        run: |
          FAILED_JOB=$(echo $JOBS | jq 'to_entries[] | select(.value.result == "failure") | .key')
          echo "FAILED_JOB=$FAILED_JOB" >> $GITHUB_ENV
      - name: report failed job
        uses: dawidd6/action-send-mail@v2
        with:
          server_address: smtp.sendgrid.net
          server_port: 587
          username: ${{ secrets.SENDGRID_USER }}
          password: ${{ secrets.SENDGRID_PASSWORD }}
          subject: 'Test Email'
          body: "Job ${{ env.FAILED_JOB }} failed"
          to: 'lxkdevtesting@gmail.com'
      
